
open Format
open Lib

type robot = {
  mutable x: int;
  mutable y: int;
  vx: int;
  vy: int;
}

let robots = ref []
let () = iter_lines stdin @@ fun s -> Scanf.sscanf s "p=%d,%d v=%d,%d" @@
  fun x y vx vy -> robots := { x; y; vx; vy } :: !robots

let width  = int_of_string Sys.argv.(1)
let height = int_of_string Sys.argv.(2)

let move r =
  let x = r.x + r.vx in
  let y = r.y + r.vy in
  r.x <- if x < 0 then x + width  else if x >= width  then x - width  else x;
  r.y <- if y < 0 then y + height else if y >= height then y - height else y

(* stop whenever there is a repetition *)
let visited = H.create 65536

let visit step =
  let pos = List.map (fun {x;y;_} -> x,y) !robots in
  if H.mem visited pos then (
    printf "step %d = step %d@." step (H.find visited pos);
    exit 0
  ) else
    H.add visited pos step

(* print all configurations *)
let display step =
  let a = Array.make_matrix height width '.' in
  let set r = a.(r.y).(r.x) <- '*' in
  List.iter set !robots;
  printf "step %d:@." step;
  Grid.print_chars std_formatter a

let () =
  let step = ref 0 in
  while true do
    visit !step;
    display !step;
    incr step;
    List.iter move !robots
  done

(* then redirect the output to a file and look for a Christmas tree

step 6771:
...............*.....................................................................................
.........*...........*...............................................................................
...............................................................*.....................................
..........................*...........*.*............................................................
.......*.......*.........................................................*...........................
.............................*....................*..................................................
..*..................................................................................................
..*..................................................................................................
...........................................................*..........*..............................
.........*...........................................................................................
...........*......*..................................................................................
......................*...........................................*..................................
.................................................................*.....*...........................*.
................................................................*....................................
*..........................................................*.......................................*.
................*....................................................................................
.........*...........................................................*...............................
..............................*......................................................................
.*...........................*....................*..................................................
.....................................................................................................
................*....................................................................................
.......................................................*.............................................
.....................................................................................................
.......*............*..................................................................*.............
.....................................................................................................
..................................................................................................*..
.....................................................................................................
.........................................................*................................*.....*....
.....................................................................................................
........................................*.............................................*..............
................................................................*...............*....................
..............................................................................*......................
...*..........*............................*...............*.......*.................................
....................................................................................................*
.............................................................................*.......................
.....................................................................................................
...............................................................................*.....................
.....................................................................................................
............................*.......................*........*..........*............................
.....................................*...............................................................
.....................................................................................................
..............*......................................................................................
..........................*..........................................................................
....................................................*.........................*..................*...
................*....................................................................................
..............*.................*...................................................*................
.........................................*...........*...............................................
.............*.........................*...............................*............*................
........................................................................*............................
..................*..................................................................................
.......................*....*.........................................................*..............
.*................................................................................*.................*
............................*******************************..........*...............................
............................*.............................*.......................*...........*......
............*...............*.............................*..........................................
............**..............*.............................*.......................*..................
............................*.............................*..........................................
............................*..............*..............*........................*...............*.
............................*.............***.............*..........................................
............................*............*****............*..........................................
.......*....................*...........*******...........*..........................................
............................*..........*********..........*..........................................
..............*.............*............*****............*..........................................
...............*............*...........*******...........*..............*...........................
............................*..........*********..........*.................................*........
............................*.........***********.........*..........................................
......................*.....*........*************........*..........................................
.........................*..*..........*********..........*..........................................
............................*.........***********.........*..........................................
............................*........*************........*..........................................
............................*.......***************.......*..........................................
.........*..................*......*****************......*..........................................
.......*..........*.........*........*************........*.....................................*....
........*...................*.......***************.......*..........................................
............................*......*****************......*...*......................................
...............*............*.....*******************.....*.....................*....................
............*...............*....*********************....*.*........................................
............................*.............***.............*.........................*................
.................*.......*..*.............***.............*.........*................................
............................*.............***.............*..........................................
.....................*......*.............................*..........................................
...................*........*.............................*..........................................
..............*.............*.............................*..........................................
............................*.............................*..........................................
............................*******************************......*...................................
.................*.................................................*......*..........................
......*....................................*.........................................................
.................................................**..................................................
.....................................................................................................
...............*.....................................................................................
.................**.......*..........................................................................
.........*..........*.................................*..................*...........................
..................*.................................................*................................
....................................................*.......................*........................
...........................................................................*..............*..........
...............*.....................................................................................
.....................................................................................................
...........................................*.........................................................
.....................................................................................................
....*................................................................................................
.................*...............................................................................*...
.............*.......................................................................................
.................................................*...................................................

*)



